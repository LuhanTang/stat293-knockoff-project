---
title: "STAT 293 Final Project: Model-X Knockoffs vs. Benjaminiâ€“Hochberg"
author: "Luhan Tang and Shengming Cheng"
date: "2025-11-20"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  markdown: 
    wrap: 72
---

---
title: "Main Analysis"
output: html_document
---

```{r setup, include=FALSE}
source("00_requirements.R")
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 7, fig.height = 5)
```

# 1. Load all methods and simulation functions

```{r load-scripts}
source("01_DataSimulation.R")
source("11_Knockoff.R")
source("21_BH.R")
source("99_RunSimulation.R")
```

# 2. Generate simulation results (Gaussian models only)

```{r generate-results}
models <- c("gaussian", "gaussian_lowdim")
q_grid <- seq(0.05, 0.25, by = 0.05)
B <- 30   # adjust if needed

results_list <- list()

for (m in models) {
  for (q in q_grid) {
    for (b in 1:B) {
      out <- simulate_once(model = m, q = q)
      results_list[[length(results_list) + 1]] <- 
        tibble::as_tibble(as.list(out))
    }
  }
}

res <- dplyr::bind_rows(results_list)

# convert numeric columns
num_cols <- setdiff(names(res), "model")
res[num_cols] <- lapply(res[num_cols], as.numeric)

res
```

# 3. Convert to long format (BH vs KO)

```{r tidy-results}
res_long <- res |>
  tidyr::pivot_longer(
    cols = c(dplyr::starts_with("BH."), dplyr::starts_with("KO.")),
    names_to = c("method", "metric"),
    names_sep = "\\.",
    values_to = "value"
  ) |>
  tidyr::pivot_wider(
    names_from = metric,
    values_from = value
  )

res_long
```

# 4. Plot Empirical FDR

```{r plot-fdr}
ggplot2::ggplot(res_long, ggplot2::aes(x = q, y = FDR, group = method, linetype = method)) +
  ggplot2::stat_summary(fun = mean, geom = "line") +
  ggplot2::facet_wrap(~ model, scales = "free_y") +
  ggplot2::geom_hline(yintercept = 0.1, linetype = "dashed") +
  ggplot2::labs(title = "Empirical FDR vs Target q",
                x = "Target q",
                y = "Empirical FDR")
```

# 5. Plot Empirical TPR

```{r plot-tpr}
ggplot2::ggplot(res_long, ggplot2::aes(x = q, y = TPR, group = method, linetype = method)) +
  ggplot2::stat_summary(fun = mean, geom = "line") +
  ggplot2::facet_wrap(~ model, scales = "free_y") +
  ggplot2::labs(title = "Empirical TPR vs Target q",
                x = "Target q",
                y = "Empirical TPR")
```

# End
